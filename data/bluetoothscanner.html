<!DOCTYPE html>
<html>

<p style="text-align: left;"><strong><a href="index.html">Main Index</a></strong></p>
<head>
  <title>SmartSpin2K Bluetooth Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body style="background-color:#3498db;">
    <h1><strong>Select Bluetooth Devices</strong></h1>
<form action="/send_settings">
<table>
    <tbody>
        <tr style="height: 20px;">
            <td style="width: 14%; height: 20px;">
                <p><label for="BluetoothPMDevices">Power Meter:</label></p>
            </td>
            <td style="width: 14%; height: 20px;"><select id="blePMDropdown" name="blePMDropdown" value="loading"></td>
        </tr>
        <tr style="height: 20px;">
            <td style="width: 14%; height: 20px;">
                <p><label for="BluetoothHRDevices">Heart Monitor:</label></p>
            </td>
            <td style="width: 14%; height: 20px;"><select id="bleHRDropdown" name="bleHRDropdown" value="loading"></td>
        </tr>
    </tbody>
</table>
<input type="submit" value="Submit" />
</form>
<p><br></p>
<form action="/BLEScan">
  <input type="submit" value="Scan for new Devices!">
</form>
</body>

<script>
    let PMDropdown = document.getElementById('blePMDropdown');
    let HRDropdown = document.getElementById('bleHRDropdown');
    PMDropdown.length = 0;
    HRDropdown.length = 0;

    let defaultOptionPM = document.createElement('option');
    defaultOptionPM.text = 'Choose Power Meter';
    let defaultOptionHR = document.createElement('option');
    defaultOptionHR.text = 'Choose Heart Monitor';

    PMDropdown.add(defaultOptionPM);
    HRDropdown.add(defaultOptionHR);
    PMDropdown.selectedIndex = 0;
    HRDropdown.selectedIndex = 0;

    const request = new XMLHttpRequest();
    request.open('GET', "/BLEServers", true);

    request.onload = function () { //TODO: these need to get sorted
        if (request.status === 200) {
            const data = JSON.parse(request.responseText);
            let optionPM;
            for (var key in data) {
                if(data[key].UUID == '0x1818'){
                optionPM = document.createElement('option');
                if (data[key].name) {
                    optionPM.text = data[key].name;
                }
                else {
                    optionPM.text = data[key].address;
                }
                PMDropdown.add(optionPM);
            }
            }
            let optionHR;
            for (var key in data) {
                if(data[key].UUID == '0x180d'){
                optionHR = document.createElement('option');
                if (data[key].name) {
                    optionHR.text = data[key].name;
                }
                else {
                    optionHR.text = data[key].address;
                }
                HRDropdown.add(optionHR);
            }
            }
        }
        else {
            // Reached the server, but it returned an error
        }
        //requestConfigValues();
    }

    request.onerror = function () {
        console.error('An error occurred fetching the JSON');
    };

    request.send();

    //define function to load css
var loadCss = function(){
    var cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = 'style.css';
    var head = document.getElementsByTagName('head')[0];
    head.parentNode.insertBefore(cssLink, head);
};
 
//Delay loading css to not swamp webserver
window.addEventListener('load', function (){
  setTimeout(loadCss, 100);
}, false);

</script>
</html>