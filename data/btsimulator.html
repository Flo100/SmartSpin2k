<!DOCTYPE html>
<html>


<head>
  <style type="text/css">
    html {
      background-color: #03245c;
    }
  </style>
  <title>SmartSpin2K Web Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <fieldset>
    <h1>
      <div class="watermark" id="loadingWatermark">Loading</div>
    </h1>
    <legend><a href="http://github.com/doudar/SmartSpin2k">http://github.com/doudar/SmartSpin2k</a></legend>
    <p style="text-align: left;"><strong><a href="index.html">Main Index</a></strong></p>
    <h1>BLE Device Simulator</h1>

    <h2>Sim Heart Rate</h2>
    <p><span id="hrValue"></span></p>
    <p><input type="range" onload="requestConfigValues()" onchange="updateHrSlider()" id="hrSlider" min="40"
        max="250" value="0" step="1" class="slider2"></p>
    <p><label class="switch"><input type="checkbox" onload="toggleHRCheckbox(this, true)"
          onchange="toggleHRCheckbox(this,true)" id="hrOutput"><span class="slider"></span></label></p>

    <h2>Sim Power Output</h2>
    <p><span id="wattsValue"></span></p>
    <p><input type="range" onload="requestConfigValues()" onchange="updateWattsSlider()" id="wattsSlider" min="0"
        max="600" value="0" step="1" class="slider2"></p>
    <p><label class="switch"><input type="checkbox" onload="toggleWattsCheckbox(this,true)"
          onchange="toggleWattsCheckbox(this,true)" id="wattsOutput"><span class="slider"></span></label></p>

    <h2>Sim CAD Output</h2>
    <p><span id="cadValue"></span></p>
    <p><input type="range" onload="requestConfigValues()" onchange="updateCadSlider()" id="cadSlider" min="0"
        max="180" value="0" step="1" class="slider2"></p>
    <p><label class="switch"><input type="checkbox" onload="toggleCadCheckbox(this,true)"
          onchange="toggleCadCheckbox(this,true)" id="cadOutput"><span class="slider"></span></label></p>

    <h1>Trainer Simulator</h1>
    <h2>Enable ERG</h2>
    <p>
      <label class="switch">
        <input type="checkbox" onload="toggleEnableErgCheckbox(this)" onchange="toggleEnableErgCheckbox(this)"
          id="enableErgCheckbox">
        <span class="slider"></span>
      </label>
    </p>
    <h2>ERG Target Watts</h2>
    <p><span id="targetWattsValue"></span></p>
    <p><input type="range" onload="requestConfigValues()" onchange="updateTargetWattsSlider()"
        id="targetWattsSlider" min="0" max="600" value="0" step="1" class="slider2"></p>
    <p>
      <label class="switch">
        <input type="checkbox" onload="toggleTargetWattsCheckbox(this,true)"
          onchange="toggleTargetWattsCheckbox(this,true)" id="targetWattsOutput">
        <span class="slider"></span>
      </label>
    </p>
</body>
<script>
  //Update values on specified interval
  setInterval(function () {
    requestConfigValues();

  }, 2000);

  let pwrTimer;

  function toggleHRCheckbox(element, updateServer) {
    if (element.checked) {
      document.getElementById("hrSlider").hidden = false;
      document.getElementById("hrValue").hidden = false;
    }
    else {
      document.getElementById("hrSlider").hidden = true;
      document.getElementById("hrValue").hidden = true;
    }
    if (updateServer) {
      var xhr = new XMLHttpRequest();
      if (element.checked) {
        xhr.open("GET", "/hrSlider?value=enable", true);
        xhr.send();
      }
      else {
        xhr.open("GET", "/hrSlider?value=disable", true);
        xhr.send();
      }
    }
  }

  function toggleWattsCheckbox(element, updateServer) {
    if (element.checked) {
      document.getElementById("wattsSlider").hidden = false;
      document.getElementById("wattsValue").hidden = false;
    }
    else {
      document.getElementById("wattsSlider").hidden = true;
      document.getElementById("wattsValue").hidden = true;
      if (!!pwrTimer) {
        clearInterval(pwrTimer);
      }
    }

    if (updateServer) {
      var xhr = new XMLHttpRequest();
      if (element.checked) {
        xhr.open("GET", "/wattsslider?value=enable", true);
        xhr.send();
      }
      else {
        xhr.open("GET", "/wattsslider?value=disable", true);
        xhr.send();
      }
    }
  }

  function toggleCadCheckbox(element, updateServer) {
    if (element.checked) {
      document.getElementById("cadSlider").hidden = false;
      document.getElementById("cadValue").hidden = false;
    }
    else {
      document.getElementById("cadSlider").hidden = true;
      document.getElementById("cadValue").hidden = true;
    }

    if (updateServer) {
      var xhr = new XMLHttpRequest();
      if (element.checked) {
        xhr.open("GET", "/cadslider?value=enable", true);
        xhr.send();
      }
      else {
        xhr.open("GET", "/cadslider?value=disable", true);
        xhr.send();
      }
    }
  }

  function updateHrSlider() {
    var sliderValue = document.getElementById("hrSlider").value;
    document.getElementById("hrValue").innerHTML = sliderValue + " BPM";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/hrSlider?value=" + sliderValue, true);
    xhr.send();
  }

  function updateWattsSlider() {
    var sliderValue = document.getElementById("wattsSlider").value;
    document.getElementById("wattsValue").innerHTML = sliderValue + " Watts";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/wattsslider?value=" + sliderValue, true);
    xhr.send();
  }

  function updateCadSlider() {
    var sliderValue = document.getElementById("cadSlider").value;
    document.getElementById("cadValue").innerHTML = sliderValue + " RPM";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/cadslider?value=" + sliderValue, true);
    xhr.send();
  }

  function updateTargetWattsSlider() {
    var sliderValue = document.getElementById("targetWattsSlider").value;
    document.getElementById("targetWattsValue").innerHTML = sliderValue + " Watts";
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/targetwattsslider?value=" + sliderValue, true);
    xhr.send();
  }

  function toggleTargetWattsCheckbox(element, updateServer) {
    if (element.checked) {
      document.getElementById("targetWattsSlider").hidden = false;
      document.getElementById("targetWattsValue").hidden = false;
    }
    else {
      document.getElementById("targetWattsSlider").hidden = true;
      document.getElementById("targetWattsValue").hidden = true;
    }

    if (updateServer) {
      var xhr = new XMLHttpRequest();
      if (element.checked) {
        xhr.open("GET", "/targetwattsslider?value=enable", true);
        xhr.send();
      }
      else {
        xhr.open("GET", "/targetwattsslider?value=disable", true);
        xhr.send();
      }
    }
  }

  function toggleEnableErgCheckbox(element) {
    var xhr = new XMLHttpRequest();
    if (element.checked) {
      xhr.open("GET", "/ergmode?value=enable", true);
      xhr.send();
    }
    else {
      xhr.open("GET", "/ergmode?value=disable", true);
      xhr.send();
    }
  }

  function requestConfigValues() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var obj = JSON.parse(this.responseText);
        document.getElementById("wattsValue").innerHTML = obj.simulatedWatts + " Watts";
        document.getElementById("wattsSlider").value = obj.simulatedWatts;
        document.getElementById("wattsOutput").checked = obj.simulateWatts;
        document.getElementById("wattsSlider").hidden = !obj.simulateWatts;
        document.getElementById("wattsValue").hidden = !obj.simulateWatts;

        document.getElementById("hrValue").innerHTML = obj.simulatedHr + " BPM";
        document.getElementById("hrSlider").value = obj.simulatedHr;
        document.getElementById("hrOutput").checked = obj.simulateHr;
        document.getElementById("hrSlider").hidden = !obj.simulateHr;
        document.getElementById("hrValue").hidden = !obj.simulateHr;

        document.getElementById("cadValue").innerHTML = obj.simulatedCad + " RPM";
        document.getElementById("cadSlider").value = obj.simulatedCad;
        document.getElementById("cadOutput").checked = obj.simulateCad;
        document.getElementById("cadSlider").hidden = !obj.simulateCad;
        document.getElementById("cadValue").hidden = !obj.simulateCad;

        document.getElementById("enableErgCheckbox").checked = obj.ERGMode;

        document.getElementById("targetWattsValue").innerHTML = obj.targetWatts + " Watts";
        document.getElementById("targetWattsSlider").value = obj.targetWatts == null ? 0 : obj.targetWatts;
        document.getElementById("targetWattsOutput").checked = obj.simulateTargetWatts;
        document.getElementById("targetWattsSlider").hidden = !obj.simulateTargetWatts;
        document.getElementById("targetWattsValue").hidden = !obj.simulateTargetWatts;

        setTimeout(function () {
          const watermark = document.getElementById("loadingWatermark");
          if (!!watermark) {
            document.getElementById("loadingWatermark")?.remove();
          }
        }, 1000);
      }
    };
    xhttp.open("GET", "/runtimeConfigJSON", true);
    xhttp.send();
  }

  //define function to load css
  var loadCss = function () {
    var cssLink = document.createElement('link');
    cssLink.rel = 'stylesheet';
    cssLink.href = 'style.css';
    var head = document.getElementsByTagName('head')[0];
    head.parentNode.insertBefore(cssLink, head);
  };

  //Delay loading css to not swamp webserver
  window.addEventListener('load', function () {
    setTimeout(loadCss, 100);
    setTimeout(requestConfigValues, 500);
  }, false);

</script>

</html>